-- Expose configuration and control to the GUI
getgenv().AimBotConfig = getgenv().AimBotConfig or {}
local config = getgenv().AimBotConfig

-- Default settings
config.visibilityCheck = true -- Enable visibility check by default
config.aimEnabled = false -- Aim is disabled by default

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer

-- Lock-on logic
local function isTargetVisible(targetHead)
    if not config.visibilityCheck then
        return true -- Skip visibility check if disabled
    end
    local camera = Workspace.CurrentCamera
    local origin = camera.CFrame.Position
    local direction = (targetHead.Position - origin).Unit * (targetHead.Position - origin).Magnitude
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {player.Character, targetHead.Parent}
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    local raycastResult = Workspace:Raycast(origin, direction, raycastParams)
    return not raycastResult -- If no obstruction, the target is visible
end

local function lockOntoPlayer(target)
    local targetHead = target:FindFirstChild("Head")
    if targetHead then
        local camera = Workspace.CurrentCamera
        local targetPosition = targetHead.Position + Vector3.new(0, 0.5, 0) -- Slight offset for better aim
        local tween = TweenService:Create(camera, TweenInfo.new(0.08, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {CFrame = CFrame.new(camera.CFrame.Position, targetPosition)})
        tween:Play()
    end
end

-- Main aim logic
RunService.RenderStepped:Connect(function()
    if config.aimEnabled and UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) then
        local camera = Workspace.CurrentCamera
        for _, target in pairs(Players:GetPlayers()) do
            if target ~= player and target.Team ~= player.Team and target.Character and target.Character:FindFirstChild("Head") then
                local head = target.Character.Head
                local headScreenPos, onScreen = camera:WorldToViewportPoint(head.Position)
                if onScreen and isTargetVisible(head) then
                    lockOntoPlayer(target.Character)
                    break
                end
            end
        end
    end
end)

-- Functions to start and stop aiming
function config.startAim()
    config.aimEnabled = true
    print("Aim enabled. Visibility Check:", config.visibilityCheck)
end

function config.stopAim()
    config.aimEnabled = false
    print("Aim disabled.")
end

print("Aimbot script loaded with visibility check:", config.visibilityCheck)
